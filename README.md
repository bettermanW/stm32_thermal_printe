## 0. 介绍
- 一款手持stm32蓝牙热敏打印机，打印大小50x40,可打印单词、标签、留言等。
## 1.硬件
- **芯片**：STM32F103CBT6 FLASH:128K RAM:20K
- **BLE**: 选用智汉RC6621A
- **电源**：可充电锂电池
- **打印模组**：精芯1_JX-2R-01
- **PCB**:
- ![pcb](3D_PCB4_6_2025-10-26.png)
## 2. 软件架构
#### 分层设计
| 模块目录        | 说明                                    |
| ----------- | ------------------------------------- |
| **Core/**   | 系统入口、外设初始化、任务调度与启动 FreeRTOS           |
| **SYSTEM/** | 管理系统任务、队列、软件定时器、统一设备接口；协调 HAL 层与 RTOS |
| **HAL/**    | 对底层外设的逻辑封装。                           |

### RTOS多任务层分析
- 分为四个任务：
	- BLE任务
	- 按键创建任务
	- 打印任务
	- 状态上报任务
#### BLE任务
```mermaid
flowchart TD
    A[BLE任务开始] --> B[初始化BLE模块 注册监听 等待连接]
    B --> C{连接成功?}
    C -- 否 --> D[继续监听 等待连接]
    C -- 是 --> E[LED灯亮 表示已连接]
    E --> F[接收BLE数据 写入 ble_rx_t 队列]
    F --> G{收到APP数据?}
    G -- 否 --> H[继续监听数据]
    G -- 是 --> I[解析APP下发数据 设置打印参数]
    I --> J[通知打印任务 执行打印]
```
#### 按键创建任务
```mermaid
flowchart TD
    A[按键任务开始 task_button] --> B[每20ms轮询一次按键]
    B --> C[检测按键事件]
    C --> D{短按?}
    D -- 是 --> E[触发打印测试事件]
    D -- 否 --> F{长按?}
    F -- 否 --> B
    F -- 是 --> G[电机开始运行 Motor Start]
    G --> H{长按释放?}
    H -- 否 --> B
    H -- 是 --> I[电机停止运行 Motor Stop]

```
#### 打印任务
```mermaid
flowchart TD
    A[打印任务开始 task_printer] --> B[获取设备状态]
    B --> C{ble_rx_t 队列长度 > 10?}
    C -- 否 --> D[等待下一次循环]
    C -- 是 --> E{当前正在打印?}
    E -- 否 --> F[设置为正在打印状态<br>上报状态 LED亮]
    F --> G[读取队列数据 执行打印]
    G --> H[打印结束 停止电机 上报状态 LED灭]
    H --> I[清空打印队列 等待下一次任务]
    E -- 是 --> J[等待当前打印完成]
```
#### 环形缓冲区RTOS（安全队列实现）
- 用 **互斥信号量 (Mutex)** 实现一个线程安全的 BLE → 打印机 缓冲区队列。
- 该函数采用信号量保护的读取操作，避免与写线程冲突。使用 10 tick 超时等待，防止死锁。通过读写指针实现环形读取，返回数据指针供打印机任务使用。
#### 状态上报任务
```mermaid
flowchart TD
    A[上报任务开始 task_report] --> B[每100ms执行一次]
    B --> C{BLE是否已连接?}
    C -- 否 --> D[跳过上报 等待下次循环]
    C -- 是 --> E[采集状态信息<br>电量 温度 缺纸 状态]
    E --> F{生产上报事件触发?}
    F -- 否 --> B
    F -- 是 --> G[执行生产状态上报]
```

## 蓝牙控制
- 使用b站up小智学长蓝牙手机app